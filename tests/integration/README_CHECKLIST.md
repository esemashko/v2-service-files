# Чеклист для интеграционных тестов

> Этот чеклист предназначен для самопроверки при написании новых интеграционных тестов.
> Структура и общие практики описаны в [README.md](./README.md)

## При добавлении новой сущности

### Файлы на сущность
- [ ] `tests/integration/<entity>_privacy_test.go`
  - CRUD + privacy для сущности.
- [ ] `tests/integration/<entity>_audit_log_privacy_test.go` (если есть аудит)
  - Privacy логов + полнота покрытия полей аудита: создание/изменение/удаление.

### Privacy и CRUD (`<entity>_privacy_test.go`)
- [ ] Роли (минимум): admin, member. Рекомендуется: owner, client (негатив), head (руководитель), подписчики/наблюдатели.
- [ ] Query: видимость записей по ролям и доступам.
- [ ] Create: кто может создавать, проверки обязательных связей/валидностей.
- [ ] Update: права на редактирование своих/чужих записей, доменные ограничения (например, 24 часа).
- [ ] Delete: кто может удалять; различать soft/hard delete, если применимо.
- [ ] Ошибки доступа: проверять ожидаемые формулировки (например, "insufficient permissions" / "access denied").
- [ ] Сокрытие недоступных данных: для чужих ресурсов — "not found" (без утечки факта существования).

### Аудит (`<entity>_audit_log_privacy_test.go`, если аудит есть)
- [ ] Privacy логов: admin/owner читают, member/client не читают; прямые операции над логами (create/update/delete) запрещены всем.
- [ ] Create: при создании сущности лог создаётся автоматически, `action` = create, корректный `user` (инициатор), `NewValues` содержит все ключевые поля (включая связи).
- [ ] Update: лог создаётся автоматически, `action` = update, корректный `user`; в `OldValues`/`NewValues` присутствуют и только изменившиеся поля; множественные изменения фиксируются все.
- [ ] Delete: для soft delete — `OldValues` содержит ключевые поля; для hard delete — поведение по требованиям (часто лог не создаётся) — проверить явно.

### Пограничные сценарии (Edge cases)
- [ ] Доступы
  - [ ] Member без доступа не видит/не меняет; member с доступом — видит/меняет свои.
  - [ ] Подписчики (если есть подписки) — видят по правилам; client даже с подпиской — без доступа к внутренним данным.
  - [ ] Head (руководитель) — расширенные права в своём департаменте.
  - [ ] Неактивный/удалённый пользователь — все операции запрещены (ошибка аутентификации).
- [ ] Доменные ограничения
  - [ ] Временные лимиты (например, 24ч): случаи < 24ч, = 24ч, > 24ч; admin/head — без ограничения.
  - [ ] Soft vs hard delete: различить поведение доступа и аудита.
- [ ] Валидации
  - [ ] Обязательные связи (типы/статусы/владельцы); неактивные/недоступные справочники.
  - [ ] Числовые границы (0, отрицательные, очень большие значения).
  - [ ] Пустые/слишком длинные строки для текстовых полей.
- [ ] Аудит-лог
  - [ ] Запрет прямых CRUD по логам.
  - [ ] Корректность актёра (`user`) и `action`.
  - [ ] Полнота ключей в `OldValues`/`NewValues` согласно требованиям сущности.

### Технические требования
- [ ] Контекст пользователя: `withUserContext(ctx, user)` или вручную через `ctxkeys`
- [ ] Системный контекст для setup: `privacy.WithSystemContext(ctx)`
- [ ] Клиент Ent в контексте: `ent.NewContext(ctx, client)`
- [ ] Структура через `t.Run()` для группировки тестов
- [ ] TestHelper для транзакционной изоляции

### Быстрая самопроверка
- [ ] Файлы созданы в правильной папке домена (`/auth`, `/user` и т.д.)
- [ ] CRUD покрыт (минимум admin/member), негатив для client
- [ ] Видимость/доступ для member: доступные/недоступные объекты
- [ ] Временные лимиты и их границы покрыты (если применимо)
- [ ] Soft/hard delete различены (если применимо)
- [ ] Аудит покрыт если есть (Create/Update/Delete, полнота полей)
- [ ] Неактивный пользователь — операции запрещены

## Быстрая проверка перед коммитом

### Запуск тестов
- [ ] Все тесты проходят: `make test-integration`
- [ ] Конкретный домен: `go test -tags=integration ./tests/integration/<domain>/... -v`
- [ ] Нет SKIP тестов из-за абортированных транзакций
- [ ] Нет игнорируемых ошибок в setup функциях

### Code Review чеклист
- [ ] Тесты изолированы (используют TestHelper)
- [ ] Уникальные тестовые данные (UnixNano)
- [ ] Правильные контексты (системный для setup, пользовательский для тестов)
- [ ] Проверены все роли (минимум admin/member)
- [ ] Покрыты edge cases
- [ ] Есть комментарии для сложной логики
